# Heartprinter Python Code

This directory contains Python code for controlling, testing, and analyzing the Heartprinter system.

---

## ⚠️ IMPORTANT: Platform Compatibility

**macOS IS NOT SUPPORTED**

This system requires NIDAQmx hardware drivers which are only available for Windows and Linux. The Heartprinter system will **NOT** work on macOS.

**Supported Platforms:**
- ✅ Windows 10/11
- ✅ Linux (Ubuntu, Debian, etc.)
- ❌ macOS (Not Compatible)

---

## Project Structure

```
code/Python/
├── core/                           # Core computation modules
│   ├── __init__.py
│   └── compute.py
├── gui/                            # GUI applications
│   ├── __init__.py
│   ├── main.py                     # Main control interface
│   └── test_interface.py           # Testing tool (substitute for C++)
├── tools/                          # Analysis and utility tools
│   ├── __init__.py
│   ├── log_analysis.py
│   ├── visualize_positions.py
│   └── position_error_calculation.py
├── README.md
└── requirements.txt
```

## File Descriptions

### Core Modules (`core/`)

#### `compute.py`
Core computation module containing mathematical functions for the Heartprinter system.
- **Functions:**
  - `read_all_points()` - Read base points from file
  - `compute_plane_mesh()` - Generate 3D mesh for visualization
  - `triangle_area()` - Calculate triangle area
  - `validate_position()` - Check if position is within valid bounds
  - `compute_heart_frame_transform()` - Calculate coordinate frame transformation
- **Data Structures:**
  - `MotorCommand` - Motor control command structure
  - `HeartprinterStatus` - System status structure
  - Shared memory struct formats for C++ interop
- **Dependencies:** numpy, pyqtgraph

### GUI Applications (`gui/`)

#### `main.py` (Main Application)
Primary GUI application for controlling the Heartprinter system in real-time.
- **Features:**
  - 3D visualization of base positions and current/target positions
  - Manual jog controls (WASD keys + Z axis)
  - Target position input and validation
  - Automated waypoint routine
  - Real-time status monitoring via shared memory
  - Triggers log analysis on system exit
- **Communication:** Shared memory (`Local\\CPPToPy`, `Local\\PyToCPP`)
- **Dependencies:** core.compute, tools.log_analysis (subprocess)
- **Usage:** `python gui/main.py` or `python -m gui.main`

#### `test_interface.py`
Testing GUI that substitutes for the C++ component during development.
- **Purpose:** Test shared memory communication without running C++ code
- **Features:**
  - Manually set base positions and status
  - Read motor commands from Python
  - Calculate motor positions
  - Monitor shared memory communication
- **Usage:** `python gui/test_interface.py` or `python -m gui.test_interface`

### Analysis Tools (`tools/`)

#### `log_analysis.py`
Comprehensive log file analyzer for Heartprinter system logs.
- **Features:**
  - Parse and analyze Heart Printer log files
  - Generate detailed text reports with statistics
  - Create multiple visualization graphs:
    - Load cell tension over time
    - Cable length tracking
    - Arrival timing charts
    - Distance vs time correlation
  - Export position error data to CSV
- **Output:**
  - Text analysis reports
  - PNG graphs (tension, cable tracking, arrival timing, distance vs time)
  - Combined CSV file with positional errors
- **Usage:**
  ```bash
  python tools/log_analysis.py <log_path_or_pattern> [-o output_dir]
  # Example: python tools/log_analysis.py "../Cpp/logs/log*" -o analysis
  ```
- **Called by:** gui/main.py (automatically on exit)

#### `visualize_positions.py`
3D visualization tool for position data from log files.
- **Features:**
  - Parse positions from log files
  - 3D visualization with matplotlib
  - Shows base positions, current position, desired position
  - Displays error vectors and in-plane distances
  - Projects positions onto base plane with cable circles
- **Usage:**
  ```bash
  python tools/visualize_positions.py <log_file>        # Show last snapshot
  python tools/visualize_positions.py <log_file> --all  # Show all snapshots
  ```

#### `position_error_calculation.py`
Statistical analysis of position errors from waypoint routines.
- **Purpose:** Calculate statistics for different waypoint positions
- **Input:** `positional_errors_combined.csv` (from log_analysis.py)
- **Output:** `position_error_statistics.csv`
- **Analyzes:** Error magnitude, time to reach, starting distance by position type
- **Usage:** `python tools/position_error_calculation.py`

## CSV Output Files

### `positional_errors_combined.csv`
Generated by `log_analysis.py` from multiple log files.
- Contains first arrival data at each new desired position
- Columns: log_file, unix_timestamp, position_set_time, arrival_time, time_to_reach_sec, starting_distance_mm, error_magnitude_mm, current_x/y/z, desired_x/y/z

### `position_error_statistics.csv`
Generated by `PositionErrorCalculation.py` from positional_errors_combined.csv.
- Statistical summary by position (Centroid, Left, Center, Right, and midpoints)
- Columns: position, count, error_mean/median/std/min/max, time_mean/median/std/min/max, distance_mean/median/std/min/max

## Dependency Graph

```
core/
└── compute.py
    └── gui/
        ├── main.py (Main GUI)
        │   └── tools/log_analysis.py (called via subprocess on exit)
        └── test_interface.py (Testing tool)

tools/
├── log_analysis.py
│   └── positional_errors_combined.csv
│       └── position_error_calculation.py
│           └── position_error_statistics.csv
└── visualize_positions.py (Standalone)
```

## Environment Setup and Installation

### Prerequisites

- **Operating System:** Windows or Linux (macOS is **not supported** due to NIDAQmx hardware dependency)
- **Python 3.8 or higher** - Download from [python.org](https://www.python.org/downloads/)
  - During installation, make sure to check "Add Python to PATH"1

### Step-by-Step Setup

#### Step 1: Open Terminal/Command Prompt

**Windows:**
- Press `Win + R`, type `cmd` or `powershell`, and press Enter
- Or open Windows Terminal from the Start menu

**Linux:**
- Open Terminal from Applications or use `Ctrl + Alt + T`

#### Step 2: Navigate to the Python Directory

Navigate to where you have the Heartprinter project on your system:

**Windows:**
```bash
cd C:\path\to\Heartprinter\code\Python
```
Examples:
- `cd C:\Projects\Heartprinter\code\Python`
- `cd C:\Users\YourUsername\Documents\Heartprinter\code\Python`

**Linux:**
```bash
cd /path/to/Heartprinter/code/Python
```
Examples:
- `cd ~/projects/Heartprinter/code/Python`
- `cd ~/Documents/Heartprinter/code/Python`
- `cd /home/username/Heartprinter/code/Python`

**Tip:** You can drag and drop the Python folder into your terminal to auto-fill the path.

#### Step 3: Verify Python Installation

```bash
python --version
```

You should see something like `Python 3.8.x` or higher. If not:
- **Linux:** Try `python3 --version`
- **Windows:** Reinstall Python and ensure "Add to PATH" is checked

#### Step 4: Create a Virtual Environment

A virtual environment isolates project dependencies from your system Python.

**Windows:**
```bash
python -m venv .venv
```

**Linux:**
```bash
python3 -m venv .venv
```

This creates a `.venv` folder containing the isolated Python environment.

#### Step 5: Activate the Virtual Environment

**Windows (Command Prompt):**
```bash
.venv\Scripts\activate.bat
```

**Windows (PowerShell):**
```bash
.venv\Scripts\Activate.ps1
```

**Note:** If you get an execution policy error in PowerShell, run:
```bash
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

**Linux:**
```bash
source .venv/bin/activate
```

**Success indicator:** Your terminal prompt should now start with `(.venv)`:

**Windows:**
```
(.venv) C:\path\to\Heartprinter\code\Python>
```

**Linux:**
```
(.venv) /path/to/Heartprinter/code/Python$
```

#### Step 6: Upgrade pip (Recommended)

```bash
python -m pip install --upgrade pip
```

#### Step 7: Install Required Packages

```bash
pip install -r requirements.txt
```

This will install:
- numpy
- pandas
- PyQt5
- pyqtgraph
- matplotlib

**Installation time:** Approximately 2-5 minutes depending on your internet connection.

#### Step 8: Verify Installation

Test that packages are installed correctly:

```bash
python -c "import numpy, pandas, PyQt5, pyqtgraph, matplotlib; print('All packages installed successfully!')"
```

If you see "All packages installed successfully!" - you're ready to go!

### Deactivating the Virtual Environment

When you're done working, deactivate the virtual environment:

```bash
deactivate
```

### Reactivating for Future Sessions

Each time you open a new terminal and want to work on the project:

1. Navigate to the Python directory:
   ```bash
   cd /path/to/Heartprinter/code/Python
   ```
   Replace with your actual project path.

2. Activate the virtual environment:
   - **Windows (CMD):** `.venv\Scripts\activate.bat`
   - **Windows (PowerShell):** `.venv\Scripts\Activate.ps1`
   - **Linux:** `source .venv/bin/activate`

### Troubleshooting

#### "python is not recognized as an internal or external command"
- Python is not in your PATH. Reinstall Python with "Add to PATH" checked
- **Alternative:** Use the full path to your Python installation:
  - **Windows:** Usually `C:\Users\<YourUsername>\AppData\Local\Programs\Python\Python3X\python.exe`
  - **Linux:** `/usr/bin/python3`

#### "Cannot be loaded because running scripts is disabled" (PowerShell)
- Run PowerShell as Administrator
- Execute: `Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser`
- Close and reopen PowerShell

#### Import errors after installation
- Make sure virtual environment is activated (look for `(.venv)` in prompt)
- Try reinstalling: `pip install --force-reinstall -r requirements.txt`

#### PyQt5 installation fails on Linux
- Install system dependencies first:
  ```bash
  sudo apt-get install python3-pyqt5 python3-pyqt5.qtopengl
  ```

#### Slow installation
- Use a mirror: `pip install -r requirements.txt -i https://pypi.org/simple`

### IDE Setup (Optional)

If using an IDE like VSCode or PyCharm:

**VSCode:**
1. Open the Python folder in VSCode
2. Press `Ctrl+Shift+P` and search for "Python: Select Interpreter"
3. Choose the interpreter from `.venv` folder

**PyCharm:**
1. File → Settings → Project → Python Interpreter
2. Click the gear icon → Add
3. Select "Existing environment" and browse to:
   - **Windows:** `.venv\Scripts\python.exe`
   - **Linux:** `.venv/bin/python`

## Quick Start

**Important:** Make sure your virtual environment is activated before running any commands!

### Running the Main GUI
```bash
python gui/main.py
```
Or using module syntax:
```bash
python -m gui.main
```
This launches the main control interface. Requires the C++ backend to be running.

### Testing Without C++ Backend
```bash
python gui/test_interface.py
```
Or using module syntax:
```bash
python -m gui.test_interface
```
Use this for testing Python-side functionality without the C++ motor control system.

### Analyzing Logs
```bash
# Windows
python tools/log_analysis.py "..\Cpp\logs\log*"

# Linux
python tools/log_analysis.py "../Cpp/logs/log*"
```
Generates analysis reports and graphs from log files.

### Calculating Position Statistics
```bash
python tools/position_error_calculation.py
```
Requires `positional_errors_combined.csv` to exist (generated by log_analysis.py).

### Visualizing Positions
```bash
# Windows
python tools/visualize_positions.py ..\Cpp\logs\log_20241201.txt

# Linux
python tools/visualize_positions.py ../Cpp/logs/log_20241201.txt
```
Creates interactive 3D visualization of position data.

## Shared Memory Communication

The system uses Windows shared memory for IPC between Python and C++:

- **CPPToPy** (`Local\\CPPToPy`): C++ writes status, Python reads
  - Format: 12 doubles (3 base positions + 1 current position) + 6-byte status string

- **PyToCPP** (`Local\\PyToCPP`): Python writes commands, C++ reads
  - Format: 3 doubles (target x,y,z) + 2 bools (execute, exit)

## Key Keyboard Shortcuts (gui_main.py)

- **W/S/A/D**: Jog in heart frame X/Y axes
- **+/-**: Jog in Z axis
- **Z**: Home to centroid
- **Enter**: Execute move to target position
